# Project overview
- Purpose: Personal blog starter built with Astro, MDX, and Tailwind. Ships with RSS, sitemap, offline search (Pagefind), and Giscus comments.
- Primary language: TypeScript/JavaScript, Astro components (.astro), and MD/MDX for content.
- Runtime/build: Astro 4.x, Node.js (CI uses Node 20; recommend Node >= 18.14).
- Hosting targets: Static hosting (Vercel / Netlify / Cloudflare Pages / OSS+CDN). All pages are statically generated.

# Tech stack
- Astro 4 (SSG) with integrations:
  - @astrojs/mdx for MDX content
  - @astrojs/tailwind for Tailwind CSS
  - @astrojs/sitemap for sitemap generation
- Styling: Tailwind CSS (dark mode via class), minimal prose tweaks.
- Search: Pagefind (post-build indexing into dist/pagefind/*).
- Comments: Giscus (GitHub Discussions based; configure your repo and category).
- RSS: @astrojs/rss route at /rss.xml.
- Formatting: Prettier config in .prettierrc.
- CI: GitHub Actions example workflow builds and runs postbuild.

# Repository layout
- package.json: scripts and dependencies.
- astro.config.mjs: Astro site config (site URL, integrations, Shiki theme, markdown settings).
- tailwind.config.cjs: Tailwind setup (darkMode: 'class', color palette extends, content globs).
- postcss.config.cjs: PostCSS with Tailwind + Autoprefixer.
- tsconfig.json: TypeScript config; path alias "@/*" -> "src/*".
- .github/workflows/ci.yml: CI to build and run Pagefind indexing.
- public/
  - favicon.svg, og-image.png, robots.txt (static assets served as-is)
  - manifest.webmanifest (PWA manifest)
  - sw.js (service worker registration in BaseLayout; production only)
  - _headers (Netlify caching headers example)
- src/
  - components/
    - Giscus.astro (comment widget; configure data-repo/id/category)
  - content/
    - posts/ (MD/MDX posts)
    - config.ts (Astro Content schema for posts)
  - layouts/
    - BaseLayout.astro (global styles import, nav, dark mode toggle)
  - pages/
    - index.astro (home, latest posts)
    - posts/[...slug].astro (post details, multi-segment slugs)
    - tags/index.astro and tags/[tag].astro (tags listing)
    - rss.xml.ts (RSS feed)
    - search.astro (Pagefind UI placeholder; loads only in production)
    - 404.astro (not found)
  - styles/
    - styles.css (Tailwind entry)
  - env.d.ts (Astro types)

# Setup & development
- Install and run dev server:
  - npm install
  - npm run dev (http://localhost:4321)
- Path alias: use import paths like "@/components/..." resolving to src/.
- Global styles are imported in BaseLayout via `import '@/styles/styles.css';`.

# Build & search indexing
- Build static site: npm run build (outputs dist/)
- Build search index (required for /search page): npm run postbuild (runs Pagefind -> dist/pagefind/*)
- Local preview with search:
  - Recommended: npm run build && npm run postbuild, then serve dist with any static server (e.g., `npx serve dist`).
  - Note: `npm run dev` does not provide search; Pagefind runs only post-build.
- Hosting on platforms:
  - Set the build command to: `npm run build && npm run postbuild` to ensure Pagefind assets are generated.

# Content model & conventions
- Posts live in src/content/posts as .md or .mdx.
- Frontmatter schema (see src/content/config.ts):
  - title: string (required)
  - description: string (optional)
  - publishDate: string | Date (required)
  - updatedDate: string | Date (optional)
  - tags: string[] (default [])
  - draft: boolean (default false)
  - cover: string (optional)
- Draft handling: posts with `draft: true` are excluded from lists and static paths.
- Slugs: derived from file path; nested folders create multi-segment slugs. Accessed at /posts/<slug>/.
- Assets: place images and static files in public/ and reference with absolute paths (e.g., /og-image.png).

# Pages & routing
- /: latest posts
- /posts/[...slug]/: post details (MD/MDX rendered; supports Content API `post.render()`)
- /tags/ and /tags/[tag]/: tag archives
- /rss.xml: RSS feed from published posts
- /search: search UI (requires postbuild)
- /404: not found

# Styling & theming
- Tailwind CSS configured with dark mode using the `class` strategy.
- Theme toggle script in BaseLayout toggles `documentElement.classList` and persists to localStorage.
- Minimal prose adjustments in src/styles/styles.css (e.g., rounded images, code block borders).

# Comments (Giscus/Waline)
- Giscus: Configure in src/components/Giscus.astro:
  - data-repo: "owner/repo"
  - data-repo-id: (from Giscus setup)
  - data-category, data-category-id: (from Giscus setup)
  - mapping: typically "pathname"
  - theme/lang as needed
- Post page renders <Giscus /> by default inside a slot; you can replace it with Waline:
  - Import `Waline` from `@/components/Waline.astro` and set `serverURL`

# Configuration notes
- Set the correct site URL in astro.config.mjs (e.g., https://blog.example.com). This is required for correct RSS and sitemap absolute URLs.
- Syntax highlighting uses Shiki with theme `github-dark` and wrapping enabled.
- Tailwind integration applies base styles; dark mode is class-based.

# CI/CD
- GitHub Actions: .github/workflows/ci.yml
  - Node 20, `npm ci`, `npm run build`, then `npm run postbuild`.
- When deploying to static hosts (Vercel/Netlify/Cloudflare Pages), ensure build command includes postbuild.

# Best practices & conventions
- Use MDX for posts requiring components or JSX; plain MD is fine for content-only posts.
- Keep dates ISO-formatted (YYYY-MM-DD) to avoid locale parsing issues; `new Date()` is used for sorting / display.
- Prefer absolute links to public assets (e.g., /images/... under public/)
- Keep tags simple (lowercase or meaningful slugs) and avoid spaces when you expect them to be part of URL.
- For China mainland audiences, consider replacing Giscus with Waline/Twikoo and using a domestic CDN; also remember ICP/备案 if hosting domestically.
- Formatting: run `npm run format` (Prettier) before commits.

# Known gotchas
- Pagefind does not run in dev server; only after `npm run postbuild`. The /search page will be empty in dev.
- Astro preview (`npm run preview`) serves SSR output and may not reflect Pagefind files if you didn’t run postbuild; prefer serving dist after build+postbuild for accurate local testing.
- Trailing slashes are used in internal links (e.g., /posts/slug/). Ensure your static host preserves pretty URLs or configure redirects accordingly.

# Common tasks
- Add a new post:
  - Create `src/content/posts/my-post.mdx` with frontmatter
  - Run: npm run build && npm run postbuild
- Add a new tag to a post:
  - Append to the `tags` array in the post’s frontmatter; tag pages are generated automatically.
- Change site title/nav/links:
  - Edit `src/layouts/BaseLayout.astro`.
- Change theme colors:
  - Edit `tailwind.config.cjs` (e.g., `theme.extend.colors.primary`).
- Update favicon / social image:
  - Replace `public/favicon.svg` and `public/og-image.png`.

# Deployment recipes
- Vercel
  - Build command: `npm run build && npm run postbuild`
  - Output directory: `dist`
  - Node version: 20 or latest LTS
  - Set project domain and add custom domain; ensure clean URLs are enabled (Vercel supports by default)
- Cloudflare Pages
  - Build command: `npm run build && npm run postbuild`
  - Build output directory: `dist`
  - Environment: Node 20
  - Set caching rules for `/pagefind/*` to be cacheable (immutable assets) and for HTML to short TTL if you update frequently
- Netlify
  - Build command: `npm run build && npm run postbuild`
  - Publish directory: `dist`
  - Optional: `_headers` to add caching for static assets; redirects not required unless you disable pretty URLs
- OSS + CDN（Aliyun/Tencent/others）
  - Locally: `npm run build && npm run postbuild`
  - Upload `dist/` to bucket; enable CDN with gzip/brotli and HTTP/2
  - Cache policy: long cache for `assets/*` and `pagefind/*`, short cache for `*.html`

# Authoring posts (MD/MDX)
- Use `.mdx` when embedding components or JSX; otherwise `.md` is fine
- Frontmatter dates: prefer ISO format (YYYY-MM-DD). Avoid locale-specific strings
- Code blocks: fenced code ```lang will be highlighted by Shiki (theme github-dark)
- Images: place under `public/` and reference via absolute path `/...`; they’ll be served as static assets
- Tags: simple, URL-safe strings (avoid spaces). Tag pages generate automatically
- Drafts: add `draft: true` to hide from builds and routes
- Nested slugs: create subfolders under `src/content/posts/` (e.g., `2025/notes/my-post.mdx` -> `/posts/2025/notes/my-post/`)

# Pagefind (search) notes
- Only runs after build. Dev server won’t load Pagefind; use `npm run build && npm run postbuild`
- The UI script is loaded in `/search` only in production. Ensure `dist/pagefind/*` exists on host
- If hosting at a subpath (base path), update the script/style URLs accordingly or configure your host to serve `/pagefind/*` at root
- You can customize UI options (translations, result layout) inside `src/pages/search.astro`

# Troubleshooting
- Build fails with content schema errors:
  - Check frontmatter fields/types against `src/content/config.ts`
  - Ensure `publishDate` is valid (ISO string or valid Date)
- Search page empty in production:
  - Confirm `npm run postbuild` ran and `dist/pagefind/` is uploaded
  - Confirm your host serves `/pagefind/pagefind.js` and `/pagefind/pagefind.css` without blocking
- Giscus not rendering:
  - Verify `data-repo`, `data-repo-id`, `data-category`, `data-category-id`
  - Confirm Discussions is enabled on the GitHub repo and category has write permissions
- Styles not applied:
  - Ensure `import '@/styles/styles.css'` is present in `BaseLayout.astro`
  - Tailwind content globs include `.astro` and `.mdx`; restart dev server after adding new file types

# Hosting notes & SEO
- Set `site` in `astro.config.mjs` to your real domain to generate correct absolute URLs for sitemap and RSS
- Consider adding canonical tags and OpenGraph/JSON-LD for posts (extend `BaseLayout.astro`)
- robots.txt already references `/sitemap-index.xml` generated by the sitemap integration
- Prefer immutable caching for static assets (assets/*, pagefind/*) and shorter cache for HTML

# China mainland deployment
- Prefer domestic CDN (Aliyun/Tencent/Volcengine/UPYUN/Qiniu) for lower latency
- If GitHub resources are blocked, replace Giscus with Waline/Twikoo (self-hosted) and self-host analytics (Umami/Matomo)
- If using domestic cloud + custom domain, handle ICP/备案 per regulations

# Future enhancements (nice-to-haves)
- SEO: canonical/OG/JSON-LD, per-post meta, breadcrumb
- Content UX: Table of contents (TOC), prev/next post navigation, reading time
- PWA: add service worker, offline cache, manifest
- Internationalization: i18n routes and localized dates
- Comments: Waline/Twikoo adapter component and server templates
- Analytics: Umami/Matomo/Cloudflare Web Analytics with opt-in tracking
- Image optimization: use Astro assets or external image CDN

# Quick start checklist
- Set `site` in `astro.config.mjs` to your production domain
- Configure Giscus repo/category IDs (or remove the component if not used)
- Write your first post under `src/content/posts/`
- `npm run build && npm run postbuild`, then deploy `dist/`
- Verify: /rss.xml, /sitemap-index.xml, /search, /tags, 404

# Coding conventions & naming
- Use path alias `@/` for imports inside `src/`
- Filenames: kebab-case for routes/components; PascalCase only for component names exported in code
- Content files: prefer kebab-case for slugs (e.g., `my-first-post.mdx`)
- Tags: lowercase, URL-safe; avoid spaces and punctuation
- Keep components presentational; avoid inlining large scripts in pages when possible

# Content authoring (MDX) tips
- Import components in MDX with relative or alias paths, e.g. `import My from '@/components/My.astro'`
- MDX supports JSX and shortcodes; keep frontmatter minimal and validated by `src/content/config.ts`
- Prefer ISO dates (YYYY-MM-DD) in `publishDate` and `updatedDate`
- Use headings in order (h2 > h3 …) to aid TOC and accessibility

# Accessibility & performance
- Ensure images have alt text; decorative images should be empty alt `alt=""`
- Test color contrast in light/dark themes; avoid primary on white without sufficient contrast
- Defer non-critical scripts; keep third-party scripts minimal (Giscus already deferred)
- Use lazy-loading for large images if you add custom image components

# SEO checklist
- Unique title/description per post (frontmatter)
- Add canonical URL and OG/Twitter tags (extend BaseLayout.astro if needed)
- Keep clean URLs with trailing slash; make sure host preserves them
- Provide RSS link in header and in footer (already present in nav)

# Extending (recipes)
- Table of contents (TOC):
  - Use a remark plugin or parse headings from `post.render()` result to render a sidebar TOC
- Math (KaTeX):
  - Install `rehype-katex` and styles; enable in Astro markdown config
- Diagrams (Mermaid):
  - Load Mermaid on demand in post pages; wrap code blocks with `language-mermaid`
- Analytics:
  - Add Umami/Matomo/Cloudflare Web Analytics snippet in BaseLayout with an environment guard

# Add another content collection (e.g., pages or notes)
- Define schema in `src/content/config.ts` with `defineCollection`
- Create files under `src/content/<collection>/`
- Add routes under `src/pages/<collection>/...` and query with `getCollection('<collection>')`

# Sitemap customization
- The sitemap integration works out-of-the-box if `site` is set
- To exclude routes (e.g., drafts or specific paths), configure the integration options in `astro.config.mjs`

# Deployment rewrites & headers
- Netlify `_headers` example (create at project root):
  - `/assets/*\n  Cache-Control: public, max-age=31536000, immutable\n\n/pagefind/*\n  Cache-Control: public, max-age=31536000, immutable\n\n/*.html\n  Cache-Control: public, max-age=60`
- Cloudflare Pages: create caching rules in dashboard for `/pagefind/*` as immutable
- OSS (Aliyun/Tencent): ensure correct MIME types (e.g., `application/javascript` for `.js`, `text/css` for `.css`); enable Brotli/Gzip

# Maintenance
- Node: use 20.x (CI) or latest LTS; align local dev with CI
- Dependencies: periodically update via `npm outdated` and `npm update` (pin major versions with care)
- Formatting: run `npm run format` before commits; consider adding a pre-commit hook if needed
- CI: add PR preview builds on your hosting provider to review changes before merge

# Keeping this guide updated
- Update `.agent.md` whenever you add integrations, scripts, or conventions
- Keep deployment steps in sync with the chosen host and build commands

